name: playwright-tests
on: 
    push:
        branches:
            - main
            - dev
    workflow_dispatch:

jobs:
    run-tests:
        runs-on: ubuntu-latest
        container:
          image: mcr.microsoft.com/dotnet/sdk:8.0
        steps:
            - uses: actions/checkout@v4

            - name: setup dotnet environment
              uses: actions/setup-dotnet@v4
              with:
                dotnet-version: 8.0.x

            - name: install dependencies and build
              run: dotnet build

            - name: check that the browsers have been installed
              run: pwsh bin/Debug/net8.0/playwright.ps1 install --with-deps

            - name: run tests
              id: run-tests
              run: dotnet test --logger "trx;LogFileName=test_results.trx" --results-directory TestReports

            # Allure history setup
            - name: Load Test Report History 
              uses: actions/checkout@v4
              if: always()
              continue-on-error: true
              with:
                ref: main
                path: report_History 

            - name: List test results folder
              if: always()
              run: |
                ls -R TestReports
                find TestReports -type f

            - name: Build test report
              uses: simple-elf/allure-report-action@v1.7
              if: always()
              with:
                gh_pages: allure-history
                allure_results: TestReports/Run_*/
                allure_history: allure-history

            - name: Publish test result
              uses: peaceiris/actions-gh-pages@v3
              if: always()
              with:
                github_token: ${{ secrets.GITHUB_TOKEN }}
                publish_branch: gh-pages      
                publish_dir: allure-history

            # Allure end

            - name: upload Trx logger file 
              if: always()
              uses: actions/upload-artifact@v4
              with:
                name: test-results
                path: '**/test_results.trx'

            - name: upload test report artifact if tests fail
              if: ${{ failure() && steps.run-tests.outcome == 'failure' }}
              uses: actions/upload-artifact@v4
              with:
                name: Test-reports-folder
                path: TestReports
